<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bill Summary</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Inter, Arial, sans-serif;
  padding: 20px;
  background: #f6f9ff;
  color: #111;
}
.container {
  max-width: 900px;
  margin: 0 auto;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
}
h1 {
  text-align: center;
}
.payer {
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 10px;
  background: #f3f7ff;
}
.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.total {
  font-weight: 800;
}
.btn {
  border: 0;
  padding: 4px 8px;
  border-radius: 6px;
  cursor: pointer;
  margin-left: 6px;
}
.edit { background: #60a5fa; color: white; }
.delete { background: #ef4444; color: white; }
#admin-panel { text-align: center; margin-bottom: 12px; }
.coin-summary {
  background: #e0f7e9;
  border: 1px solid #b7f5cc;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 16px;
}
</style>
</head>
<body>
<div class="container">
  <h1>üí≥ Accepted Bills & Coin Summary</h1>

  <div id="admin-panel">
    <button id="admin-login-btn">üîê Admin Login</button>
    <span id="admin-status"></span>
  </div>

  <div id="coin-summary" class="coin-summary"></div>
  <div id="summary"></div>

  <div style="margin-top:16px;text-align:right">
    <button onclick="location.href='index.html'">‚Üê Back</button>
  </div>
</div>

<script>
/* -------------------------------
   Firebase setup
--------------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyCRU75_SPgrDPtI9VYMOsMA71E2eoV6AG4",
  authDomain: "meals-kcc.firebaseapp.com",
  databaseURL: "https://meals-kcc-default-rtdb.firebaseio.com",
  projectId: "meals-kcc",
  storageBucket: "meals-kcc.appspot.com",
  messagingSenderId: "821150881161",
  appId: "1:821150881161:web:d50b0398370b0e19e5fd58"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -------------------------------
   State & DOM refs
--------------------------------*/
let IS_ADMIN = false;
const summaryEl = document.getElementById('summary');
const adminStatus = document.getElementById('admin-status');
const coinSummaryEl = document.getElementById('coin-summary');

/* -------------------------------
   Admin login
--------------------------------*/
document.getElementById('admin-login-btn').addEventListener('click', ()=>{
  const pw = prompt('Enter admin password:');
  if(pw === 'sunoo'){
    IS_ADMIN = true;
    adminStatus.textContent = '‚úÖ Admin Mode Enabled';
    renderBills();
  } else if(pw) alert('Incorrect password.');
});

/* -------------------------------
   Load and render bills (reordered)
   - Flatten entries, compute timestamps
   - Sort rows by timestamp (newest first)
   - Compute subtotals, then sort payers by subtotal (desc)
--------------------------------*/
function renderBills(){
  db.ref('bills').once('value').then(snap=>{
    const data = snap.val() || {};
    const entries = [];

    // Flatten all accepted entries into an array with timestamps
    for(const payerKey of Object.keys(data || {})){
      const payerObj = data[payerKey] || {};
      for(const dateKey of Object.keys(payerObj || {})){
        const dateObj = payerObj[dateKey] || {};
        for(const timeKey of Object.keys(dateObj || {})){
          const entry = dateObj[timeKey];
          if(entry && entry.accepted){
            // try to build a timestamp from date + time; fall back to Date.parse variants
            let ts = NaN;
            try {
              ts = new Date(`${dateKey} ${timeKey}`).getTime();
              if(isNaN(ts)) ts = Date.parse(`${dateKey}T${timeKey}`);
            } catch(e){
              ts = NaN;
            }
            entries.push({
              payer: payerKey,
              date: dateKey,
              time: timeKey,
              amount: Number(entry.amount || 0),
              orderUser: entry.orderUser || '',
              ts: isNaN(ts) ? 0 : ts
            });
          }
        }
      }
    }

    if(entries.length === 0){
      summaryEl.innerHTML = '<i>No accepted bills yet.</i>';
      coinSummaryEl.innerHTML = '<i>No coins yet recorded.</i>';
      return;
    }

    // Group by payer after sorting rows, and compute subtotals
    // First sort rows (newest first)
    entries.sort((a,b)=>b.ts - a.ts);

    const byPayer = {};
    const subtotals = {};
    entries.forEach(e=>{
      if(!byPayer[e.payer]) byPayer[e.payer] = [];
      byPayer[e.payer].push(e);
      subtotals[e.payer] = (subtotals[e.payer] || 0) + Number(e.amount || 0);
    });

    // Now build payer list sorted by subtotal descending (so biggest payers first)
    const payersSorted = Object.keys(byPayer)
      .sort((a,b)=> (subtotals[b] || 0) - (subtotals[a] || 0) );

    // helper to escape single quotes for inline onclick attributes
    function escAttr(s){
      return String(s).replace(/'/g, "\\'").replace(/\n/g, ' ');
    }

    let html = '';
    let grandTotal = 0;

    for(const payer of payersSorted){
      const rows = byPayer[payer];
      let subtotal = 0;
      html += `<div class="payer"><div style="font-weight:700">${payer}</div>`;
      rows.forEach(r=>{
        subtotal += Number(r.amount || 0);
        // escape attributes used inside single quotes
        const payerEsc = escAttr(r.payer);
        const dateEsc = escAttr(r.date);
        const timeEsc = escAttr(r.time);
        const amountVal = Number(r.amount || 0);
        html += `<div class="row">
          <div>${r.date} ${r.time} ‚Äî ${r.orderUser || ''}</div>
          <div>${amountVal.toFixed(2)}
            ${IS_ADMIN ? `
              <button class="btn edit" onclick="editBill('${payerEsc}','${dateEsc}','${timeEsc}',${amountVal})">‚úè</button>
              <button class="btn delete" onclick="deleteBill('${payerEsc}','${dateEsc}','${timeEsc}')">üóë</button>` : ''}
          </div>
        </div>`;
      });
      html += `<div class="row total"><div>Subtotal</div><div>${subtotal.toFixed(2)}</div></div></div>`;
      grandTotal += subtotal;
    }

    html += `<div style="text-align:right;font-weight:800;margin-top:10px">Grand total: ${grandTotal.toFixed(2)}</div>`;

    summaryEl.innerHTML = html;

    // Build coin summary from subtotals (use sorted payers order)
    const totalCoins = {};
    for(const p of Object.keys(subtotals)){
      totalCoins[p] = subtotals[p];
    }
    renderCoinSummary(totalCoins);
  }).catch(err=>{
    console.error('Error loading bills:', err);
    summaryEl.innerHTML = '<i>Error loading bills.</i>';
    coinSummaryEl.innerHTML = '';
  });
}

/* -------------------------------
   Coin summary
--------------------------------*/
function renderCoinSummary(coinData){
  if(!Object.keys(coinData).length){
    coinSummaryEl.innerHTML = '<i>No coins yet recorded.</i>';
    return;
  }
  let html = '<h3>üí∞ Total Coins (Paid Amounts)</h3>';
  html += '<ul style="list-style:none;padding:0">';
  let totalAll = 0;
  // Sort coin display by amount desc for a cleaner summary
  const items = Object.entries(coinData).sort((a,b)=>b[1]-a[1]);
  for(const [payer, amount] of items){
    html += `<li style="margin-bottom:4px">${payer}: <b>${Number(amount).toFixed(2)} coins</b></li>`;
    totalAll += Number(amount || 0);
  }
  html += `<li style="margin-top:6px;font-weight:700">Grand Total: ${totalAll.toFixed(2)} coins</li></ul>`;
  coinSummaryEl.innerHTML = html;
}

/* -------------------------------
   Edit & Delete for Admin
--------------------------------*/
window.editBill = function(payer, date, time, oldAmount){
  if(!IS_ADMIN) return alert('Admin only.');
  const newAmount = prompt(`Edit amount (was ${oldAmount}):`, oldAmount);
  if(newAmount === null) return;
  const val = parseFloat(newAmount);
  if(isNaN(val)) return alert('Invalid number.');
  db.ref(`bills/${payer}/${date}/${time}/amount`).set(val).then(()=>{
    alert('Updated ‚úÖ');
    renderBills();
  }).catch(err=>{
    console.error('Update failed', err);
    alert('Update failed.');
  });
};

window.deleteBill = function(payer, date, time){
  if(!IS_ADMIN) return alert('Admin only.');
  if(confirm('Delete this bill entry?')){
    db.ref(`bills/${payer}/${date}/${time}`).remove().then(()=>{
      alert('Deleted ‚úÖ');
      renderBills();
    }).catch(err=>{
      console.error('Delete failed', err);
      alert('Delete failed.');
    });
  }
};

/* -------------------------------
   Init
--------------------------------*/
renderBills();
</script>
</body>
</html>

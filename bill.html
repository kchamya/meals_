<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bill Summary</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Inter, Arial, sans-serif;
  padding: 20px;
  background: #f6f9ff;
  color: #111;
}
.container {
  max-width: 900px;
  margin: 0 auto;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
}
h1 {
  text-align: center;
}
.payer {
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 10px;
  background: #f3f7ff;
}
.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.total {
  font-weight: 800;
}
.btn {
  border: 0;
  padding: 4px 8px;
  border-radius: 6px;
  cursor: pointer;
  margin-left: 6px;
}
.edit { background: #60a5fa; color: white; }
.delete { background: #ef4444; color: white; }
#admin-panel { text-align: center; margin-bottom: 12px; }
.coin-summary {
  background: #e0f7e9;
  border: 1px solid #b7f5cc;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 16px;
}
</style>
</head>
<body>
<div class="container">
  <h1>üí≥ Accepted Bills & Coin Summary</h1>

  <div id="admin-panel">
    <button id="admin-login-btn">üîê Admin Login</button>
    <span id="admin-status"></span>
  </div>

  <div id="coin-summary" class="coin-summary"></div>
  <div id="summary"></div>

  <div style="margin-top:16px;text-align:right">
    <button onclick="location.href='index.html'">‚Üê Back</button>
  </div>
</div>

<script>
/* -------------------------------
   Firebase setup
--------------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyCRU75_SPgrDPtI9VYMOsMA71E2eoV6AG4",
  authDomain: "meals-kcc.firebaseapp.com",
  databaseURL: "https://meals-kcc-default-rtdb.firebaseio.com",
  projectId: "meals-kcc",
  storageBucket: "meals-kcc.appspot.com",
  messagingSenderId: "821150881161",
  appId: "1:821150881161:web:d50b0398370b0e19e5fd58"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -------------------------------
   State & DOM refs
--------------------------------*/
let IS_ADMIN = false;
const summaryEl = document.getElementById('summary');
const adminStatus = document.getElementById('admin-status');
const coinSummaryEl = document.getElementById('coin-summary');

/* -------------------------------
   Admin login
--------------------------------*/
document.getElementById('admin-login-btn').addEventListener('click', ()=>{
  const pw = prompt('Enter admin password:');
  if(pw === 'sunoo'){
    IS_ADMIN = true;
    adminStatus.textContent = '‚úÖ Admin Mode Enabled';
    renderBills();
  } else if(pw) alert('Incorrect password.');
});

/* -------------------------------
   Load and render bills
--------------------------------*/
function renderBills(){
  db.ref('bills').once('value').then(snap=>{
    const data = snap.val() || {};
    const byPayer = {};
    let totalCoins = {};

    // Group by payer
    for(const payer of Object.keys(data)){
      for(const date of Object.keys(data[payer] || {})){
        for(const time of Object.keys(data[payer][date] || {})){
          const entry = data[payer][date][time];
          if(entry && entry.accepted){
            if(!byPayer[payer]) byPayer[payer] = [];
            byPayer[payer].push({
              date, time,
              amount: entry.amount || 0,
              orderUser: entry.orderUser || '',
              payer
            });
          }
        }
      }
    }

    // Build UI
    let html = '';
    let grandTotal = 0;

    for(const payer of Object.keys(byPayer)){
      const rows = byPayer[payer];
      let subtotal = 0;
      html += `<div class="payer"><div style="font-weight:700">${payer}</div>`;
      rows.forEach(r=>{
        subtotal += Number(r.amount || 0);
        html += `<div class="row">
          <div>${r.date} ${r.time} ‚Äî ${r.orderUser || ''}</div>
          <div>${Number(r.amount).toFixed(2)}
            ${IS_ADMIN ? `
              <button class="btn edit" onclick="editBill('${r.payer}','${r.date}','${r.time}',${r.amount})">‚úè</button>
              <button class="btn delete" onclick="deleteBill('${r.payer}','${r.date}','${r.time}')">üóë</button>` : ''}
          </div>
        </div>`;
      });
      html += `<div class="row total"><div>Subtotal</div><div>${subtotal.toFixed(2)}</div></div></div>`;
      grandTotal += subtotal;
      totalCoins[payer] = subtotal;
    }

    if(!html) html = '<i>No accepted bills yet.</i>';
    else html += `<div style="text-align:right;font-weight:800;margin-top:10px">Grand total: ${grandTotal.toFixed(2)}</div>`;

    summaryEl.innerHTML = html;
    renderCoinSummary(totalCoins);
  });
}

/* -------------------------------
   Coin summary
--------------------------------*/
function renderCoinSummary(coinData){
  if(!Object.keys(coinData).length){
    coinSummaryEl.innerHTML = '<i>No coins yet recorded.</i>';
    return;
  }
  let html = '<h3>üí∞ Total Coins (Paid Amounts)</h3>';
  html += '<ul style="list-style:none;padding:0">';
  let totalAll = 0;
  for(const [payer, amount] of Object.entries(coinData)){
    html += `<li style="margin-bottom:4px">${payer}: <b>${amount.toFixed(2)} coins</b></li>`;
    totalAll += amount;
  }
  html += `<li style="margin-top:6px;font-weight:700">Grand Total: ${totalAll.toFixed(2)} coins</li></ul>`;
  coinSummaryEl.innerHTML = html;
}

/* -------------------------------
   Edit & Delete for Admin
--------------------------------*/
window.editBill = function(payer, date, time, oldAmount){
  if(!IS_ADMIN) return alert('Admin only.');
  const newAmount = prompt(`Edit amount (was ${oldAmount}):`, oldAmount);
  if(newAmount === null) return;
  const val = parseFloat(newAmount);
  if(isNaN(val)) return alert('Invalid number.');
  db.ref(`bills/${payer}/${date}/${time}/amount`).set(val).then(()=>{
    alert('Updated ‚úÖ');
    renderBills();
  });
};

window.deleteBill = function(payer, date, time){
  if(!IS_ADMIN) return alert('Admin only.');
  if(confirm('Delete this bill entry?')){
    db.ref(`bills/${payer}/${date}/${time}`).remove().then(()=>{
      alert('Deleted ‚úÖ');
      renderBills();
    });
  }
};

/* -------------------------------
   Init
--------------------------------*/
renderBills();
</script>
</body>
</html>

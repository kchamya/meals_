<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bill Summary</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Inter, Arial, sans-serif;
  padding: 20px;
  background: #f6f9ff;
  color: #111;
}
.container {
  max-width: 900px;
  margin: 0 auto;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
}
h1 {
  text-align: center;
}
.payer {
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 10px;
  background: #f3f7ff;
}
.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.total {
  font-weight: 800;
}
.btn {
  border: 0;
  padding: 4px 8px;
  border-radius: 6px;
  cursor: pointer;
  margin-left: 6px;
}
.edit { background: #60a5fa; color: white; }
.delete { background: #ef4444; color: white; }
#admin-panel { text-align: center; margin-bottom: 12px; }
.coin-summary {
  background: #e0f7e9;
  border: 1px solid #b7f5cc;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 16px;
}
</style>
</head>
<body>
<div class="container">
  <h1>üí≥ Accepted Bills & Coin Summary</h1>

  <div id="admin-panel">
    <button id="admin-login-btn">üîê Admin Login</button>
    <span id="admin-status"></span>
  </div>

  <div id="coin-summary" class="coin-summary"></div>
  <div id="summary"></div>

  <div style="margin-top:16px;text-align:right">
    <button onclick="location.href='index.html'">‚Üê Back</button>
  </div>
</div>

<script>
/* -------------------------------
   Firebase setup
--------------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyCRU75_SPgrDPtI9VYMOsMA71E2eoV6AG4",
  authDomain: "meals-kcc.firebaseapp.com",
  databaseURL: "https://meals-kcc-default-rtdb.firebaseio.com",
  projectId: "meals-kcc",
  storageBucket: "meals-kcc.appspot.com",
  messagingSenderId: "821150881161",
  appId: "1:821150881161:web:d50b0398370b0e19e5fd58"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -------------------------------
   State & DOM refs
--------------------------------*/
let IS_ADMIN = false;
const summaryEl = document.getElementById('summary');
const adminStatus = document.getElementById('admin-status');
const coinSummaryEl = document.getElementById('coin-summary');

/* -------------------------------
   Admin login
--------------------------------*/
document.getElementById('admin-login-btn').addEventListener('click', ()=> {
  const pw = prompt('Enter admin password:');
  if(pw === 'sunoo'){
    IS_ADMIN = true;
    adminStatus.textContent = '‚úÖ Admin Mode Enabled';
    renderBills();
  } else if(pw) alert('Incorrect password.');
});

/* -------------------------------
   Load and render orders (matches orders/{date}/{payer})
--------------------------------*/
function renderBills(){
  db.ref('orders').once('value').then(snap=>{
    const data = snap.val() || {};
    const entries = [];

    // We expect orders structure: orders/{date}/{payer} -> { status, total, ts, user, ... }
    for(const dateKey of Object.keys(data || {})){
      const dateObj = data[dateKey] || {};
      for(const payerKey of Object.keys(dateObj || {})){
        const entry = dateObj[payerKey];
        if(!entry) continue;
        // treat either entry.accepted truthy OR entry.status === 'accepted'
        const isAccepted = Boolean(entry.accepted) || String(entry.status || '').toLowerCase() === 'accepted';
        if(!isAccepted) continue;

        // timestamp: prefer numeric ts field, fall back to Date parse of date + optional time field
        let ts = Number(entry.ts || 0);
        if(isNaN(ts) || ts === 0){
          try {
            // if you have a time field in the entry, use it; otherwise parse date only
            const maybeTime = entry.time ? `${dateKey} ${entry.time}` : `${dateKey}`;
            ts = new Date(maybeTime).getTime();
            if(isNaN(ts)) ts = 0;
          } catch(e){
            ts = 0;
          }
        }

        entries.push({
          payer: payerKey,
          date: dateKey,
          time: entry.time || '',
          amount: Number(entry.amount || entry.total || 0),
          orderUser: entry.orderUser || entry.user || '',
          ts: ts
        });
      }
    }

    if(entries.length === 0){
      summaryEl.innerHTML = '<i>No accepted bills yet.</i>';
      coinSummaryEl.innerHTML = '<i>No coins yet recorded.</i>';
      return;
    }

    // Sort rows newest first
    entries.sort((a,b)=>b.ts - a.ts);

    // Group by payer and compute subtotals
    const byPayer = {};
    const subtotals = {};
    entries.forEach(e=>{
      if(!byPayer[e.payer]) byPayer[e.payer] = [];
      byPayer[e.payer].push(e);
      subtotals[e.payer] = (subtotals[e.payer] || 0) + Number(e.amount || 0);
    });

    // Sort payers by subtotal descending
    const payersSorted = Object.keys(byPayer)
      .sort((a,b)=> (subtotals[b] || 0) - (subtotals[a] || 0) );

    function escAttr(s){
      return String(s).replace(/'/g, "\\'").replace(/\n/g, ' ');
    }

    let html = '';
    let grandTotal = 0;

    for(const payer of payersSorted){
      const rows = byPayer[payer];
      let subtotal = 0;
      html += `<div class="payer"><div style="font-weight:700">${payer}</div>`;
      rows.forEach(r=>{
        subtotal += Number(r.amount || 0);
        const payerEsc = escAttr(r.payer);
        const dateEsc = escAttr(r.date);
        const timeEsc = escAttr(r.time);
        const amountVal = Number(r.amount || 0);
        html += `<div class="row">
          <div>${r.date}${r.time ? ' ' + r.time : ''} ‚Äî ${r.orderUser || ''}</div>
          <div>${amountVal.toFixed(2)}
            ${IS_ADMIN ? `
              <button class="btn edit" onclick="editBill('${dateEsc}','${payerEsc}',${amountVal})">‚úè</button>
              <button class="btn delete" onclick="deleteBill('${dateEsc}','${payerEsc}')">üóë</button>` : ''}
          </div>
        </div>`;
      });
      html += `<div class="row total"><div>Subtotal</div><div>${subtotal.toFixed(2)}</div></div></div>`;
      grandTotal += subtotal;
    }

    html += `<div style="text-align:right;font-weight:800;margin-top:10px">Grand total: ${grandTotal.toFixed(2)}</div>`;

    summaryEl.innerHTML = html;

    // Build coin summary from subtotals
    renderCoinSummary(subtotals);
  }).catch(err=>{
    console.error('Error loading orders:', err);
    summaryEl.innerHTML = '<i>Error loading orders.</i>';
    coinSummaryEl.innerHTML = '';
  });
}

/* -------------------------------
   Coin summary
--------------------------------*/
function renderCoinSummary(coinData){
  if(!Object.keys(coinData).length){
    coinSummaryEl.innerHTML = '<i>No coins yet recorded.</i>';
    return;
  }
  let html = '<h3>üí∞ Total Coins (Paid Amounts)</h3>';
  html += '<ul style="list-style:none;padding:0">';
  let totalAll = 0;
  const items = Object.entries(coinData).sort((a,b)=>b[1]-a[1]);
  for(const [payer, amount] of items){
    html += `<li style="margin-bottom:4px">${payer}: <b>${Number(amount).toFixed(2)} coins</b></li>`;
    totalAll += Number(amount || 0);
  }
  html += `<li style="margin-top:6px;font-weight:700">Grand Total: ${totalAll.toFixed(2)} coins</li></ul>`;
  coinSummaryEl.innerHTML = html;
}

/* -------------------------------
   Edit & Delete for Admin (adapted to orders/{date}/{payer})
--------------------------------*/
window.editBill = function(date, payer, oldAmount){
  if(!IS_ADMIN) return alert('Admin only.');
  const newAmount = prompt(`Edit amount (was ${oldAmount}):`, oldAmount);
  if(newAmount === null) return;
  const val = parseFloat(newAmount);
  if(isNaN(val)) return alert('Invalid number.');
  // update total and amount keys to be safe
  db.ref(`orders/${date}/${payer}/total`).set(val);
  db.ref(`orders/${date}/${payer}/amount`).set(val);
  db.ref(`orders/${date}/${payer}/amount`).then(()=>{}); // keep consistent
  db.ref(`orders/${date}/${payer}/total`).once('value').then(()=>{
    alert('Updated ‚úÖ');
    renderBills();
  }).catch(err=>{
    console.error('Update failed', err);
    alert('Update failed.');
  });
};

window.deleteBill = function(date, payer){
  if(!IS_ADMIN) return alert('Admin only.');
  if(confirm('Delete this order entry?')){
    db.ref(`orders/${date}/${payer}`).remove().then(()=>{
      alert('Deleted ‚úÖ');
      renderBills();
    }).catch(err=>{
      console.error('Delete failed', err);
      alert('Delete failed.' );
    });
  }
};

/* -------------------------------
   Init
--------------------------------*/
renderBills();
</script>
</body>
</html>

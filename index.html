<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Family Meal Planner</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg:#f4f7fc; --card:#fff; --accent:#3b82f6; --danger:#dc2626;
}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); margin:0;padding:20px;color:#111}
.container{max-width:900px;margin:0 auto;background:var(--card);border-radius:12px;padding:24px;box-shadow:0 8px 30px rgba(2,6,23,0.08)}
h1{ text-align:center; margin:6px 0 18px; background:linear-gradient(90deg,#007bff,#00bcd4); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-size:26px;}
.grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:inherit;padding:12px;border-radius:10px;position:relative}
label.item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid #e6eefb;background:#fbfdff;margin-top:6px}
.controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
button{background:linear-gradient(90deg,#007bff,#00bcd4);color:white;border:0;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:600}
button.secondary{background:#f3f4f6;color:#111}
button.green{background:#16a34a;width:100%;padding:10px 12px}
button.orange{background:#f97316;width:100%;padding:10px 12px;margin-top:8px}
#lock-message{color:var(--danger);font-weight:700;margin-top:8px}
#orders-list{max-height:240px;overflow:auto;padding:8px;border-radius:8px;background:#f3f6fb}
.small-btn{padding:6px 8px;border-radius:6px;font-size:0.9em}
.accept-btn{margin-left:8px}
.summary-item{margin-bottom:6px;border-bottom:1px dashed #e6eefb;padding-bottom:6px}
.edit-btn{background:transparent;color:#111;border:none;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:0.8em;margin-left:6px}
.modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:999}
.modal{background:white;padding:20px;border-radius:10px;width:360px;max-width:95%}
.modal h3{margin-top:0;font-size:18px}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input{width:100%;padding:6px;margin-top:4px;border:1px solid #cbd5e1;border-radius:6px}
.modal button{margin-top:10px;width:100%}

/* Top-right coin display */
#coin-display{
  position:fixed;
  top:20px;
  right:20px;
  background:linear-gradient(90deg,#fbbf24,#f59e0b);
  color:white;
  font-weight:700;
  padding:6px 12px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  z-index:999;
  cursor:pointer;
}
.coin-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eef2ff'}
.coin-row input[type="number"]{width:80px;padding:6px;border-radius:6px;border:1px solid #cbd5e1}
.add-btn{padding:6px 8px;border-radius:6px}

/* Dim accepted orders */
.order-accepted{opacity:0.6;color:#475569}
.order-pending{opacity:1;color:#0f172a}

/* Simple table for bills */
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid #e6eefb;padding:8px;text-align:left}
.table th{background:#f8fafc;font-weight:700}
</style>
</head>
<body>
<div id="coin-display" title="Coins">ü™ô 0</div>

<div class="container">
  <h1>üçΩÔ∏è Meal Planner</h1>

  <div style="text-align:center;margin-bottom:14px">
    <button id="member-btn">Member</button>
    <button id="admin-login-btn" class="secondary">Admin Login</button>
    <span id="current-user" style="margin-left:12px;font-weight:700"></span>
  </div>

  <div class="grid">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Menu ‚Äî Select Your Dishes</h3>
        <button id="add-section-btn" class="secondary small-btn" style="display:none">+ Add Section</button>
      </div>
      <div id="menu-list"></div>
      <div id="lock-message"></div>
    </div>

    <div class="card">
      <div class="controls">
        <select id="meal-type">
          <option>Lunch</option>
          <option>Dinner</option>
        </select>
        <input id="order-date" type="date" disabled style="padding:8px;border-radius:6px;border:1px solid #dbe7ff">
      </div>

      <h3>Order Summary</h3>
      <div id="summary"></div>

      <div style="margin-top:10px">
        <button id="submit-btn" class="green">‚úÖ SEND</button>
        <!-- replaced View Bills with Past Orders for members -->
        <button id="past-orders-btn" class="orange">üìú Past Orders</button>
      </div>

      <div class="card admin-section" id="admin-section" style="display:none;margin-top:12px">
        <h4 style="margin:0 0 8px">üîê Admin Controls</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button id="lock-btn" class="secondary small-btn">Lock Orders</button>
          <button id="reset-btn" class="secondary small-btn">Reset All</button>
          <button id="reload-orders-btn" class="secondary small-btn" style="display:none">Reload Orders</button>
          <!-- admin-only bills summary -->
          <button id="bills-btn" class="secondary small-btn" style="display:none">Bills</button>
        </div>
        <h4 style="margin:8px 0">All Orders</h4>
        <div id="orders-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal-backdrop" class="modal-backdrop">
  <div class="modal" id="modal-content"></div>
</div>

<script>
/* -------------------------
   Firebase initialization
------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCRU75_SPgrDPtI9VYMOsMA71E2eoV6AG4",
  authDomain: "meals-kcc.firebaseapp.com",
  databaseURL: "https://meals-kcc-default-rtdb.firebaseio.com",
  projectId: "meals-kcc",
  storageBucket: "meals-kcc.appspot.com",
  messagingSenderId: "821150881161",
  appId: "1:821150881161:web:d50b0398370b0e19e5fd58"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -------------------------
   Members list (fixed)
   - Using these display names as keys in Firebase coins/
   - Only Chamya is admin
------------------------- */
const MEMBERS = [
  { display: 'Amma', key: 'Amma' },
  { display: 'Thaththa', key: 'Thaththa' },
  { display: 'Chamya', key: 'Chamya' }
];

window.MENU_SECTIONS = {};
window.USER_NAME = localStorage.getItem('familyMealName') || "Guest";
window.IS_ADMIN = localStorage.getItem('isAdmin') === 'true' && window.USER_NAME === 'Chamya';
window.LOCKED = false;
window.UI_ORDERS_CLEARED = false; // <-- new flag: when true, admin cleared the interface only
const INITIAL_COINS = 100;

const menuList = document.getElementById('menu-list');
const summaryEl = document.getElementById('summary');
const currentUserEl = document.getElementById('current-user');
const lockMessageEl = document.getElementById('lock-message');
const adminSection = document.getElementById('admin-section');
const lockBtn = document.getElementById('lock-btn');
const ordersListEl = document.getElementById('orders-list');
const submitBtn = document.getElementById('submit-btn');
const addSectionBtn = document.getElementById('add-section-btn');
const modalBackdrop = document.getElementById('modal-backdrop');
const modalContent = document.getElementById('modal-content');
const coinDisplay = document.getElementById('coin-display');
const orderDateInput = document.getElementById('order-date');
const reloadOrdersBtn = document.getElementById('reload-orders-btn');
const resetBtn = document.getElementById('reset-btn');

const pastOrdersBtn = document.getElementById('past-orders-btn');
const billsBtn = document.getElementById('bills-btn');

orderDateInput.value = new Date().toISOString().slice(0,10);

/* -------------------------
   UI updates
------------------------- */
function updateCurrentUserDisplay(){ 
  currentUserEl.textContent = window.USER_NAME; 
  updateCoinDisplay();
  adminSection.style.display = window.IS_ADMIN ? 'block' : 'none';
  addSectionBtn.style.display = window.IS_ADMIN ? 'inline-block' : 'none';
  // show reload button only to admin
  if(reloadOrdersBtn) reloadOrdersBtn.style.display = window.IS_ADMIN ? 'inline-block' : 'none';
  // show Clear All Orders label only to admin
  if(resetBtn) resetBtn.style.display = window.IS_ADMIN ? 'inline-block' : 'none';
  if(resetBtn) resetBtn.textContent = window.IS_ADMIN ? 'Clear All Orders' : 'Reset All';
  // show bills button only to admin
  if(billsBtn) billsBtn.style.display = window.IS_ADMIN ? 'inline-block' : 'none';
}
updateCurrentUserDisplay();

/* -------------------------
   Ensure admin PIN default
------------------------- */
function ensureAdminPinDefault(){
  const pinRef = db.ref('admin/pin');
  pinRef.once('value').then(snap=>{
    if(!snap.exists()){
      pinRef.set('1234');
    }
  }).catch(()=>{});
}
ensureAdminPinDefault();

function syncLockedState(){
  db.ref('locked').on('value', snap=>{
    const val = snap.val();
    window.LOCKED = !!val;
    lockMessageEl.textContent = window.LOCKED ? 'Orders are LOCKED by admin' : '';
    lockBtn.textContent = window.LOCKED ? 'Unlock Orders' : 'Lock Orders';
  });
}
syncLockedState();

/* -------------------------
   Firebase helpers
------------------------- */
function loadMenuFromFirebase(callback){
  db.ref('menu').once('value').then(snap=>{
    window.MENU_SECTIONS = snap.val() || {};
    callback && callback();
  }).catch(err=>{ window.MENU_SECTIONS = {}; callback && callback(); });
}

function getCoins(user){
  if(!user) user = window.USER_NAME;
  return db.ref('coins/'+encodeKey(user)).once('value').then(snap=>{
    if(snap.exists()) return Number(snap.val());
    db.ref('coins/'+encodeKey(user)).set(INITIAL_COINS);
    return INITIAL_COINS;
  });
}

function setCoins(user, amount){
  if(!user) user = window.USER_NAME;
  return db.ref('coins/'+encodeKey(user)).set(amount);
}

function addCoins(user, delta){
  if(!user) user = window.USER_NAME;
  const ref = db.ref('coins/'+encodeKey(user));
  return ref.transaction(curr=>{
    if(curr === null) return (INITIAL_COINS + delta);
    return Number(curr) + Number(delta);
  });
}

/* -------------------------
   Utilities
------------------------- */
function encodeKey(s){ return String(s).replace(/\./g,'_'); }
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* -------------------------
   Render menu (same as before)
------------------------- */
function renderMenu(selectedItems = {}){
  menuList.innerHTML = '';
  const sections = window.MENU_SECTIONS || {};
  const sectionKeys = Object.keys(sections);
  if(sectionKeys.length === 0){
    menuList.innerHTML = `<div style="opacity:.7">No menu found. Admins: add sections/items in Firebase or use "Add Section".</div>`;
    return;
  }
  for (const section of sectionKeys){
    const itemsObj = sections[section] || {};
    const secDiv = document.createElement('div');
    secDiv.style.display='flex'; secDiv.style.justifyContent='space-between'; secDiv.style.alignItems='center';
    secDiv.innerHTML = `<strong>${section}</strong>`;
    if(window.IS_ADMIN){
      const btn = document.createElement('button');
      btn.textContent='‚úé';
      btn.className='edit-btn';
      btn.addEventListener('click',()=>editSection(section));
      secDiv.appendChild(btn);
    }
    menuList.appendChild(secDiv);

    const itemsArray = Object.entries(itemsObj || {});
    if(itemsArray.length === 0){
      const emptyMsg = document.createElement('div');
      emptyMsg.style.opacity = '.7';
      emptyMsg.style.margin = '6px 0 0 6px';
      emptyMsg.textContent = '(no items in this section)';
      menuList.appendChild(emptyMsg);
    }
    itemsArray.forEach(([key, item])=>{
      const label = document.createElement('label');
      label.className='item';
      const itemCoins = (typeof item.coins === 'number') ? item.coins : (parseInt(item.coins) || 0);
      const coinDisplayRepeats = itemCoins <= 0 ? 'üîò' : 'ü™ô'.repeat(Math.min(5, Math.max(1, itemCoins)));
      label.innerHTML = `
  <span style="display:flex;justify-content:space-between;align-items:center; width:100%;">
    <span style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" data-section="${escapeHtml(section)}" data-id="${escapeHtml(key)}" ${selectedItems[key] ? 'checked' : ''} /> 
      <span>${escapeHtml(item.name || key)}</span>
    </span>
    <span style="margin-left:auto">${coinDisplayRepeats}</span>
  </span>`;
      if(window.IS_ADMIN){
        const btn = document.createElement('button');
        btn.textContent='‚ãØ';
        btn.className='edit-btn';
        btn.addEventListener('click',()=>editItem(section, key));
        label.appendChild(btn);
      }
      menuList.appendChild(label);
    });
  }
}

/* -------------------------
   Modal helpers
------------------------- */
function showModal(html){
  modalContent.innerHTML = html;
  modalBackdrop.style.display='flex';
}
function closeModal(){ modalBackdrop.style.display='none'; modalContent.innerHTML=''; }

/* -------------------------
   Add/Edit (admin) - same as earlier
------------------------- */
addSectionBtn.onclick = ()=>{
  showModal(`
    <h3>Add Section</h3>
    <label>Section Name:</label>
    <input id="new-section-name"/>
    <button id="add-sec-btn">Add Section</button>
    <button id="add-sec-cancel" class="secondary">Cancel</button>
  `);
  document.getElementById('add-sec-cancel').onclick = closeModal;
  document.getElementById('add-sec-btn').onclick = ()=>{
    const name = document.getElementById('new-section-name').value.trim();
    if(!name){ alert('Enter section name'); return; }
    db.ref('menu/'+name).set({}).then(()=>{ 
      window.MENU_SECTIONS[name] = {};
      renderMenu();
      closeModal();
    });
  }
}

function editSection(section){
  showModal(`
    <h3>Edit Section: ${escapeHtml(section)}</h3>
    <label>New Item Name:</label>
    <input id="edit-item-name"/>
    <label>Coins (number):</label>
    <input id="edit-item-coins" type="number" min="0" value="1"/>
    <button id="add-item-btn">Add Item</button>
    <button id="close-edit" class="secondary">Close</button>
  `);
  document.getElementById('close-edit').onclick = closeModal;
  document.getElementById('add-item-btn').onclick = ()=>{
    const name = document.getElementById('edit-item-name').value.trim();
    const coins = parseInt(document.getElementById('edit-item-coins').value) || 0;
    if(!name){ alert('Item name required'); return; }
    const key = 'i'+Date.now();
    const updates = {};
    updates['/menu/'+section+'/'+key] = { name, coins };
    db.ref().update(updates).then(()=> loadMenuFromFirebase(()=>{ renderMenu(); closeModal(); }));
  }
}

function editItem(section, key){
  const item = (window.MENU_SECTIONS[section] || {})[key] || {};
  showModal(`
    <h3>Edit Item</h3>
    <label>Name</label><input id="itm-name" value="${escapeHtml(item.name || '')}"/>
    <label>Coins</label><input id="itm-coins" type="number" min="0" value="${item.coins || 0}"/>
    <button id="save-itm">Save</button>
    <button id="del-itm" class="secondary">Delete</button>
    <button id="close-itm" class="secondary">Close</button>
  `);
  document.getElementById('close-itm').onclick = closeModal;
  document.getElementById('save-itm').onclick = ()=>{
    const name = document.getElementById('itm-name').value.trim();
    const coins = parseInt(document.getElementById('itm-coins').value) || 0;
    db.ref('menu/'+section+'/'+key).set({ name, coins }).then(()=> loadMenuFromFirebase(()=>{ renderMenu(); closeModal(); }));
  };
  document.getElementById('del-itm').onclick = ()=>{
    if(!confirm('Delete item?')) return;
    db.ref('menu/'+section+'/'+key).remove().then(()=> loadMenuFromFirebase(()=>{ renderMenu(); closeModal(); }));
  }
}

/* -------------------------
   Member chooser (popup)
------------------------- */
document.getElementById('member-btn').addEventListener('click', ()=>{
  const win = window.open('', '', 'width=320,height=320');
  win.document.write(`
    <html><body style="font-family:sans-serif;text-align:center;padding:16px;">
      <h3>Select Member</h3>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:center;margin-top:8px">
        <button onclick="sel('Amma')">Amma</button>
        <button onclick="sel('Thaththa')">Thaththa</button>
        <button onclick="sel('Chamya')">Chamya</button>
        <button onclick="sel('Guest')">Guest</button>
      </div>
      <script>
        function sel(n){
          try{
            window.opener.localStorage.setItem('familyMealName', n);
            window.opener.USER_NAME = n;
            window.opener.localStorage.setItem('familyMealName', n);
            if(typeof window.opener.updateCurrentUserDisplay === 'function') window.opener.updateCurrentUserDisplay();
          }catch(e){ console.warn('could not update parent', e); }
          window.close();
        }
      <\/script>
    </body></html>
  `);
});

/* -------------------------
   Admin login (only Chamya allowed)
------------------------- */
document.getElementById('admin-login-btn').addEventListener('click', ()=> {
  showModal(`
    <h3>Admin Login</h3>
    <label>PIN:</label>
    <input id="admin-pin" type="password"/>
    <button id="admin-login-go">Login</button>
    <button id="admin-cancel" class="secondary">Cancel</button>
  `);
  document.getElementById('admin-cancel').onclick = closeModal;
  document.getElementById('admin-login-go').onclick = ()=>{
    const pin = document.getElementById('admin-pin').value.trim();
    db.ref('admin/pin').once('value').then(snap=>{
      const correct = snap.exists() ? snap.val() : '1234';
      if(pin === correct){
        // enforce that only Chamya may be admin
        if(window.USER_NAME !== 'Chamya'){
          alert('Only Chamya can be admin. Select Chamya as the active member first.');
          return;
        }
        window.IS_ADMIN = true;
        localStorage.setItem('isAdmin','true');
        updateCurrentUserDisplay();
        closeModal();
        alert('Admin logged in as Chamya');
        // when admin logs in, restore UI cleared flag to false so they can see orders
        window.UI_ORDERS_CLEARED = false;
        loadAllOrders();
      } else {
        alert('Wrong PIN');
      }
    }).catch(e=>{ console.error(e); alert('Error checking PIN'); });
  };
});

/* -------------------------
   Coin display click behavior:
   - If admin (Chamya): open Coin Summary modal (list all members, can add coins)
   - If member: simple alert with own balance (no refill UI)
------------------------- */
coinDisplay.addEventListener('click', async ()=>{
  if(window.IS_ADMIN && window.USER_NAME === 'Chamya'){
    // show coin summary for all members with add button
    showModal(`<h3>Coin Summary</h3><div id="coin-list" style="max-height:300px;overflow:auto;margin-top:8px"></div><button id="close-coins" class="secondary">Close</button>`);
    document.getElementById('close-coins').onclick = closeModal;
    const coinListEl = document.getElementById('coin-list');

    // read current coin values for members
    for(const m of MEMBERS){
      const row = document.createElement('div');
      row.className = 'coin-row';
      row.innerHTML = `<div style="font-weight:700">${escapeHtml(m.display)}</div>
                       <div id="bal-${escapeHtml(m.key)}">...</div>`;
      coinListEl.appendChild(row);

      const controls = document.createElement('div');
      controls.style.display='flex';
      controls.style.gap='8px';
      controls.style.marginTop='6px';
      controls.style.padding='6px';
      controls.innerHTML = `<input id="add-${escapeHtml(m.key)}" type="number" min="1" placeholder="Add coins" />
                            <button id="doadd-${escapeHtml(m.key)}" class="add-btn">Add</button>`;
      coinListEl.appendChild(controls);

      // wire add action
      (function(key){
        document.getElementById('doadd-'+key).addEventListener('click', ()=>{
          const valEl = document.getElementById('add-'+key);
          const amt = parseInt(valEl.value) || 0;
          if(amt <= 0){ alert('Enter positive number'); return; }
          addCoins(key, amt).then(()=>{ valEl.value=''; alert('Added '+amt+' coins to '+key); });
        });
      })(escapeHtml(m.key));
    }

    // realtime show balances for members
    const balancesRef = db.ref('coins');
    const updateBalances = (snap)=>{
      const data = snap.val() || {};
      for(const m of MEMBERS){
        const el = document.getElementById('bal-'+escapeHtml(m.key));
        if(el) el.textContent = (data[m.key] !== undefined) ? data[m.key] : INITIAL_COINS;
      }
    };
    balancesRef.once('value').then(updateBalances);
    // also attach listener so admin sees instant updates
    balancesRef.on('value', updateBalances);

    // stop listening when modal closes
    const cleanUp = ()=> balancesRef.off('value', updateBalances);
    // override close to cleanup
    document.getElementById('close-coins').onclick = ()=>{
      cleanUp();
      closeModal();
    };
  } else {
    // regular member: show own balance in a simple alert (no refill)
    const bal = await getCoins(window.USER_NAME);
    alert(`${window.USER_NAME} ‚Äî ${bal} coins`);
  }
});

/* -------------------------
   Update coin display for current user (top-right)
------------------------- */
function updateCoinDisplay(){
  getCoins(window.USER_NAME).then(c=>{
    coinDisplay.textContent = `ü™ô ${c}`;
  }).catch(()=>{ coinDisplay.textContent = 'ü™ô -'; });
}

/* -------------------------
   Build summary & order submission (same behavior)
------------------------- */
menuList.addEventListener('change', (e)=>{
  if(e.target && e.target.matches('input[type="checkbox"]')){
    updateSummary();
  }
});

function collectSelected(){
  const selected = {};
  const boxes = menuList.querySelectorAll('input[type="checkbox"]');
  boxes.forEach(b=>{
    if(b.checked){
      const section = b.getAttribute('data-section');
      const id = b.getAttribute('data-id');
      selected[id] = { section, id };
    }
  });
  return selected;
}

function updateSummary(){
  const sel = collectSelected();
  let total = 0;
  const listEl = document.createElement('div');
  Object.values(sel).forEach(s=>{
    const sec = window.MENU_SECTIONS[s.section] || {};
    const item = sec[s.id] || {};
    const name = item.name || s.id;
    const coins = Number(item.coins) || 0;
    total += coins;
    const itemDiv = document.createElement('div');
    itemDiv.className = 'summary-item';
    itemDiv.textContent = `${name} ‚Äî ${coins} coins`;
    listEl.appendChild(itemDiv);
  });
  const totalDiv = document.createElement('div');
  totalDiv.style.fontWeight = '700';
  totalDiv.textContent = `Total: ${total} coins`;
  listEl.appendChild(totalDiv);
  summaryEl.innerHTML = '';
  summaryEl.appendChild(listEl);
}

/* -------------------------
   Submit order flow (same as before)
------------------------- */
submitBtn.addEventListener('click', async ()=>{
  if(window.LOCKED){ alert('Orders are locked by admin.'); return; }
  const sel = collectSelected();
  const selKeys = Object.keys(sel);
  if(selKeys.length === 0){ alert('Select at least one item.'); return; }

  let cost = 0;
  const items = [];
  for(const k of selKeys){
    const s = sel[k];
    const it = (window.MENU_SECTIONS[s.section] || {})[s.id] || {};
    const name = it.name || s.id;
    const coins = Number(it.coins) || 0;
    cost += coins;
    items.push({ name, coins, section: s.section, id: s.id });
  }

  try{
    const coinSnapshot = await db.ref('coins/'+encodeKey(window.USER_NAME)).once('value');
    const curCoins = coinSnapshot.exists() ? Number(coinSnapshot.val()) : INITIAL_COINS;
    if(curCoins < cost){
      if(!confirm(`You have ${curCoins} coins but the order costs ${cost}. Top-up needed.`)) return;
      alert('Only admin can top-up. Please ask Chamya to add coins.' );
      return;
    }

    const coinRef = db.ref('coins/'+encodeKey(window.USER_NAME));
    await coinRef.transaction(curr=>{
      if(curr === null) return (INITIAL_COINS - cost);
      if(curr - cost < 0) return;
      return curr - cost;
    });

    const dateKey = orderDateInput.value || new Date().toISOString().slice(0,10);
    const orderRef = db.ref('orders/'+dateKey+'/'+encodeKey(window.USER_NAME));
    const payload = { user: window.USER_NAME, items, total: cost, meal: document.getElementById('meal-type').value || 'Lunch', ts: Date.now() };
    await orderRef.set(payload);

    alert('Order submitted!');
    updateCoinDisplay();
    menuList.querySelectorAll('input[type="checkbox"]').forEach(b=>b.checked = false);
    updateSummary();
    if(window.IS_ADMIN) loadAllOrders();
  }catch(e){ console.error(e); alert('Error submitting order'); }
});

/* -------------------------
   Past Orders (member)
   - Opens a popup window that shows the current user's past orders grouped by date
   - Shows a bottom line with total coins spent by that user
------------------------- */
pastOrdersBtn.addEventListener('click', ()=>{
  const user = window.USER_NAME || 'Guest';
  const encUser = encodeKey(user);
  const win = window.open('', '_blank', 'width=700,height=600,scrollbars=yes');
  const html = `
  <!doctype html>
  <html>
  <head>
    <meta charset="utf-8"/>
    <title>Past Orders - ${escapeHtml(user)}</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
    <style>
      body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:16px;background:#f7fbff;color:#0f172a}
      h2{margin-top:0}
      .card{background:white;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:12px}
      .items{font-size:0.95em;color:#334155}
      .total{font-weight:800;margin-top:12px;padding-top:10px;border-top:1px dashed #e6eefb}
    </style>
  </head>
  <body>
    <h2>Past Orders ‚Äî ${escapeHtml(user)}</h2>
    <div id="content">Loading...</div>
    <script>
      const firebaseConfig = ${JSON.stringify(firebaseConfig)};
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const encUser = ${JSON.stringify(encUser)};
      const userDisplay = ${JSON.stringify(user)};
      function formatDate(d){ return d; }
      db.ref('orders').once('value').then(snap=>{
        const all = snap.val() || {};
        const content = document.getElementById('content');
        const dates = Object.keys(all).sort((a,b)=> b.localeCompare(a)); // newest first
        let totalSpent = 0;
        content.innerHTML = '';
        for(const date of dates){
          const users = all[date] || {};
          if(!users[encUser]) continue;
          const ord = users[encUser];
          const card = document.createElement('div');
          card.className = 'card';
          const d = document.createElement('div');
          d.innerHTML = '<strong>' + date + '</strong> ‚Äî ' + (ord.meal || '') + ' ‚Äî ' + (ord.total || 0) + ' coins';
          card.appendChild(d);
          const itemsDiv = document.createElement('div');
          itemsDiv.className = 'items';
          if(ord.items && ord.items.length){
            itemsDiv.innerHTML = ord.items.map(it=> escapeHtml(it.name) + ' ('+ (it.coins||0) +' coins)').join('<br/>');
          } else {
            itemsDiv.textContent = '(no items recorded)';
          }
          card.appendChild(itemsDiv);
          if(ord.ts){
            const t = new Date(ord.ts);
            const tsDiv = document.createElement('div');
            tsDiv.style.fontSize='0.85em'; tsDiv.style.marginTop='8px'; tsDiv.style.color='#64748b';
            tsDiv.textContent = 'Submitted: ' + t.toLocaleString();
            card.appendChild(tsDiv);
          }
          content.appendChild(card);
          totalSpent += Number(ord.total || 0);
        }
        const tot = document.createElement('div');
        tot.className = 'total';
        tot.textContent = 'Total coins spent by ' + userDisplay + ': ' + totalSpent + ' coins';
        content.appendChild(tot);
        if(content.innerHTML === ''){
          content.textContent = 'No past orders found for ' + userDisplay;
        }
      }).catch(e=>{
        document.getElementById('content').textContent = 'Error loading past orders';
        console.error(e);
      });

      function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    <\/script>
  </body>
  </html>
  `;
  win.document.write(html);
  win.document.close();
});

/* -------------------------
   Admin Bills (summary for all members)
   - Admin-only popup that shows each member's past orders and total spent
------------------------- */
if(billsBtn){
  billsBtn.addEventListener('click', ()=>{
    if(!window.IS_ADMIN){ alert('Admin only'); return; }
    const win = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
    const html = `
    <!doctype html>
    <html>
    <head>
      <meta charset="utf-8"/>
      <title>Admin ‚Äî Bills Summary</title>
      <meta name="viewport" content="width=device-width,initial-scale=1"/>
      <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
      <style>
        body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:16px;background:#f7fbff;color:#0f172a}
        h2{margin-top:0}
        .card{background:white;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:12px}
        .member-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eef2ff}
        .items{font-size:0.95em;color:#334155}
        .total{font-weight:800;margin-top:12px;padding-top:10px;border-top:1px dashed #e6eefb}
        table.table{width:100%;border-collapse:collapse;margin-top:8px}
        table.table th, table.table td{border:1px solid #e6eefb;padding:8px;text-align:left}
        table.table th{background:#f8fafc}
      </style>
    </head>
    <body>
      <h2>Admin ‚Äî Bills Summary</h2>
      <div id="content">Loading...</div>
      <script>
        const firebaseConfig = ${JSON.stringify(firebaseConfig)};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const MEMBERS = ${JSON.stringify(MEMBERS)};
        function encodeKey(s){ return String(s).replace(/\\./g,'_'); }
        function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        db.ref('orders').once('value').then(snap=>{
          const all = snap.val() || {};
          const content = document.getElementById('content');
          content.innerHTML = '';
          // prepare per-member summary
          const per = {};
          for(const m of MEMBERS){
            per[m.key] = { display: m.display, key: m.key, orders: [], total: 0 };
          }
          // collect orders
          for(const [date, users] of Object.entries(all)){
            for(const [u, ord] of Object.entries(users || {})){
              // attempt to find matching member by encoded key OR by ord.user name fallback
              const matchedKey = Object.keys(per).indexOf(u) >= 0 ? u : (ord && ord.user && per[encodeKey(ord.user)] ? encodeKey(ord.user) : null);
              if(matchedKey && per[matchedKey]){
                per[matchedKey].orders.push(Object.assign({ date }, ord));
                per[matchedKey].total += Number(ord.total || 0);
              } else {
                // unknown user: include in "Others"
                if(!per['__others']) per['__others'] = { display: 'Others', key: '__others', orders: [], total: 0 };
                per['__others'].orders.push(Object.assign({ date }, ord));
                per['__others'].total += Number(ord.total || 0);
              }
            }
          }

          // show a table summary
          const tbl = document.createElement('table');
          tbl.className = 'table';
          tbl.style.width='100%';
          tbl.innerHTML = '<thead><tr><th>Member</th><th># Orders</th><th>Total Spent (coins)</th><th>Actions</th></tr></thead><tbody></tbody>';
          const tbody = tbl.querySelector('tbody');
          for(const k of Object.keys(per)){
            const entry = per[k];
            const tr = document.createElement('tr');
            tr.innerHTML = '<td>' + escapeHtml(entry.display) + '</td><td>' + entry.orders.length + '</td><td>' + entry.total + '</td><td><button class="view-orders" data-key="'+escapeHtml(entry.key)+'">View</button></td>';
            tbody.appendChild(tr);
          }
          content.appendChild(tbl);

          // buttons to view each member's detailed list
          content.addEventListener('click', (e)=>{
            if(e.target && e.target.matches('button.view-orders')){
              const key = e.target.getAttribute('data-key');
              const entry = per[key];
              if(!entry) return;
              // open a modal-ish new window showing orders for this member
              const w = window.open('', '_blank', 'width=720,height=600,scrollbars=yes');
              let inner = '<!doctype html><html><head><meta charset="utf-8"/><title>Orders - '+escapeHtml(entry.display)+'</title><meta name="viewport" content="width=device-width,initial-scale=1"/><style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:16px;background:#f7fbff;color:#0f172a} .card{background:white;padding:12px;border-radius:8px;margin-bottom:10px} .items{font-size:0.95em;color:#334155} .total{font-weight:800;margin-top:12px;padding-top:10px;border-top:1px dashed #e6eef2}</style></head><body>';
              inner += '<h3>Orders for '+escapeHtml(entry.display)+'</h3>';
              if(entry.orders.length === 0){
                inner += '<div>No orders found.</div>';
              } else {
                entry.orders.sort((a,b)=> b.date.localeCompare(a.date));
                for(const ord of entry.orders){
                  inner += '<div class="card"><div><strong>'+escapeHtml(ord.date)+'</strong> ‚Äî '+escapeHtml(ord.meal||'')+' ‚Äî '+(ord.total||0)+' coins</div>';
                  if(ord.items && ord.items.length){
                    inner += '<div class="items">'+ ord.items.map(it=> escapeHtml(it.name) + ' ('+(it.coins||0)+' coins)').join('<br/>') + '</div>';
                  }
                  if(ord.ts){
                    inner += '<div style="font-size:0.85em;color:#64748b;margin-top:8px">Submitted: ' + new Date(ord.ts).toLocaleString() + '</div>';
                  }
                  inner += '</div>';
                }
                inner += '<div class="total">Total spent by '+escapeHtml(entry.display)+': ' + entry.total + ' coins</div>';
              }
              inner += '</body></html>';
              w.document.write(inner);
              w.document.close();
            }
          });

        }).catch(e=>{
          document.getElementById('content').textContent = 'Error loading bills summary';
          console.error(e);
        });
      <\/script>
    </body>
    </html>
    `;
    win.document.write(html);
    win.document.close();
  });
}

/* -------------------------
   View bills button handler (removed) ‚Äî old behavior replaced by Past Orders
------------------------- */
/* document.getElementById('view-bills-btn').addEventListener('click', ()=>{ ... }); */

/* -------------------------
   Admin helpers: loadAllOrders, lock/unlock, reset
   - CHANGED: "Clear All Orders" (admin only) removes rejected orders from Firebase.
   - loadAllOrders now orders: pending first, accepted last. Accepted orders are dimmed.
------------------------- */
function loadAllOrders(){
  // if admin previously cleared the interface, don't auto-repopulate until they explicitly reload
  if(window.UI_ORDERS_CLEARED) return;

  db.ref('orders').once('value').then(snap=>{
    ordersListEl.innerHTML = '';
    if(!snap.exists()){ ordersListEl.innerHTML = '<div style="opacity:.7">No orders</div>'; return; }
    const allDates = snap.val() || {};
    // sort dates descending for recent first
    const entries = Object.entries(allDates).sort((a,b)=> b[0].localeCompare(a[0]));
    for(const [date, users] of entries){
      const dateH = document.createElement('div');
      dateH.style.fontWeight='700'; dateH.style.marginTop='8px'; dateH.textContent = date;
      ordersListEl.appendChild(dateH);

      // Convert users object into array and sort by status:
      // pending/undefined first (rank 0), accepted last (rank 1)
      const userEntries = Object.entries(users || {});
      const statusRank = (s)=> {
        if(!s || s === 'pending') return 0;
        if(s === 'accepted') return 1;
        // any other statuses (including 'rejected') go after pending but before accepted
        return 0;
      };
      userEntries.sort((a,b)=>{
        const ra = statusRank(a[1].status);
        const rb = statusRank(b[1].status);
        if(ra !== rb) return ra - rb;
        // keep original order for same rank
        return 0;
      });

      for(const [u, ord] of userEntries){
        // Skip rejected if for some reason still present (clear operation should have removed them)
        const status = ord.status || 'pending';
        if(status === 'rejected') continue;

        const div = document.createElement('div');
        div.style.margin = '6px 0'; div.style.padding = '6px'; div.style.border = '1px solid #e6eefb'; div.style.borderRadius = '6px';

        // Apply dimming for accepted orders
        if(status === 'accepted'){
          div.classList.add('order-accepted');
        } else {
          div.classList.add('order-pending');
        }

        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${ord.user}</strong> ‚Äî ${ord.meal || ''} ‚Äî ${ord.total} coins</div>
            <div style="font-size:0.9em;font-weight:700;color:${status === 'accepted' ? '#475569' : '#334155'}">${status}</div>
          </div>
          <div style="font-size:0.9em;color:#334155;margin-top:6px">${(ord.items || []).map(it=>it.name+'('+it.coins+')').join(', ')}</div>
        `;

        if(window.IS_ADMIN){
          // Accept button
          const acceptBtn = document.createElement('button');
          acceptBtn.className = 'accept-btn';
          acceptBtn.textContent = "‚úîÔ∏è Accept";
          acceptBtn.onclick = ()=>{
            db.ref(`orders/${date}/${u}/status`).set("accepted").then(()=>{ loadAllOrders(); });
          };

          // Reject button
          const rejectBtn = document.createElement('button');
          rejectBtn.className = 'accept-btn';
          rejectBtn.textContent = "‚ùå Reject";
          rejectBtn.onclick = ()=>{
            db.ref(`orders/${date}/${u}/status`).set("rejected").then(()=>{ loadAllOrders(); });
          };

          // Add buttons to a container
          const btnWrap = document.createElement('div');
          btnWrap.style.marginTop = '8px';
          btnWrap.appendChild(acceptBtn);
          btnWrap.appendChild(rejectBtn);
          div.appendChild(btnWrap);
        }

        ordersListEl.appendChild(div);
      }
    }
  });
}

/* -------------------------
   Lock/unlock button
------------------------- */
lockBtn.addEventListener('click', ()=>{
  if(!window.IS_ADMIN){ alert('Admin only'); return; }
  const newVal = !window.LOCKED;
  db.ref('locked').set(newVal);
});

/* -------------------------
   Clear All Orders (formerly Reset All)
   - Admin-only action.
   - Removes rejected orders from Firebase and reloads the list.
------------------------- */
if(resetBtn){
  resetBtn.textContent = 'Clear All Orders';
  resetBtn.addEventListener('click', async ()=>{
    if(!window.IS_ADMIN){ alert('Admin only'); return; }
    if(!confirm('Clear all orders: this will permanently remove all rejected orders from Firebase. Accepted and pending orders will remain. Proceed?')) return;
    try{
      const snap = await db.ref('orders').once('value');
      if(!snap.exists()){
        alert('No orders to clear.');
        return;
      }
      const all = snap.val() || {};
      const updates = {};
      for(const [date, users] of Object.entries(all)){
        for(const [u, ord] of Object.entries(users || {})){
          const status = ord.status || 'pending';
          if(status === 'rejected'){
            updates[`/orders/${date}/${u}`] = null;
          }
        }
      }
      if(Object.keys(updates).length > 0){
        await db.ref().update(updates);
      }
      // ensure UI cleared flag is false so admin sees updated list
      window.UI_ORDERS_CLEARED = false;
      loadAllOrders();
      alert('Rejected orders removed. Accepted orders will be dimmed and shown after pending orders.');
    }catch(e){
      console.error(e);
      alert('Error clearing orders');
    }
  });
}

/* -------------------------
   Reload orders button
------------------------- */
if(reloadOrdersBtn){
  reloadOrdersBtn.addEventListener('click', ()=>{
    if(!window.IS_ADMIN){ alert('Admin only'); return; }
    // allow repopulating the UI again and fetch live orders
    window.UI_ORDERS_CLEARED = false;
    loadAllOrders();
    alert('Orders reloaded from Firebase.');
  });
}

/* -------------------------
   Initialize & realtime listeners
------------------------- */
loadMenuFromFirebase(()=>{ renderMenu(); updateSummary(); if(window.IS_ADMIN) loadAllOrders(); });

db.ref('menu').on('value', snap=>{ window.MENU_SECTIONS = snap.val() || {}; renderMenu(); updateSummary(); });
// only auto-load orders if admin and they have NOT cleared the UI
db.ref('orders').on('value', snap=>{ if(window.IS_ADMIN && !window.UI_ORDERS_CLEARED) loadAllOrders(); });
// update top-right balance when user's coin changes
db.ref('coins/'+encodeKey(window.USER_NAME)).on('value', snap=>{ if(snap.exists()) coinDisplay.textContent = 'ü™ô ' + snap.val(); });

window.updateCurrentUserDisplay = updateCurrentUserDisplay;
modalBackdrop.addEventListener('click', e=>{ if(e.target === modalBackdrop) closeModal(); });

</script>
</body>
</html>
